/// <reference types="node" />
/// <reference types="node/http" />
import Koa from "koa";
import { Request, Response, NextFunction } from "express";
import { IncomingHttpHeaders } from "http";
import { ClassRegistration, RegistrationDefaults } from "../decorators";
import { Logger as DBOSLogger } from "../telemetry/logs";
import { UserDatabaseClient } from "../user_database";
import { HTTPRequest } from "../context";
import { Span } from "@opentelemetry/sdk-trace-base";
import { W3CTraceContextPropagator } from "@opentelemetry/core";
import { OpenAPIV3 as OpenApi3 } from "openapi-types";
export interface MiddlewareContext {
    readonly koaContext: Koa.Context;
    readonly name: string;
    readonly requiredRole: string[];
    readonly logger: DBOSLogger;
    readonly span: Span;
    getConfig<T>(key: string, deflt: T | undefined): T | undefined;
    query<C extends UserDatabaseClient, R, T extends unknown[]>(qry: (dbclient: C, ...args: T) => Promise<R>, ...args: T): Promise<R>;
}
/**
 * Authentication middleware that executes before a request reaches a function.
 * This is expected to:
 *   - Validate the request found in the handler context and extract auth information from the request.
 *   - Map the HTTP request to the user identity and roles defined in app.
 * If this succeeds, return the current authenticated user and a list of roles.
 * If any step fails, throw an error.
 */
export type DBOSHttpAuthMiddleware = (ctx: MiddlewareContext) => Promise<DBOSHttpAuthReturn | void>;
export interface DBOSHttpAuthReturn {
    authenticatedUser: string;
    authenticatedRoles: string[];
}
export interface MiddlewareDefaults extends RegistrationDefaults {
    authMiddleware?: DBOSHttpAuthMiddleware;
    koaBodyParser?: Koa.Middleware;
    koaCors?: Koa.Middleware;
    koaMiddlewares?: Koa.Middleware[];
    koaGlobalMiddlewares?: Koa.Middleware[];
}
export declare class MiddlewareClassRegistration<CT extends {
    new (...args: unknown[]): object;
}> extends ClassRegistration<CT> implements MiddlewareDefaults {
    authMiddleware?: DBOSHttpAuthMiddleware;
    koaBodyParser?: Koa.Middleware;
    koaCors?: Koa.Middleware;
    koaMiddlewares?: Koa.Middleware[];
    koaGlobalMiddlewares?: Koa.Middleware[];
    constructor(ctor: CT);
}
/**
 * Define an authentication function for each endpoint in this class.
 */
export declare function Authentication(authMiddleware: DBOSHttpAuthMiddleware): <T extends new (...args: unknown[]) => object>(ctor: T) => void;
/**
 * Define a Koa body parser applied before any middleware. If not set, the default @koa/bodyparser is used.
 */
export declare function KoaBodyParser(koaBodyParser: Koa.Middleware): <T extends new (...args: unknown[]) => object>(ctor: T) => void;
/**
 * Define a Koa CORS policy applied before any middleware. If not set, the default @koa/cors (w/ .yaml config) is used.
 */
export declare function KoaCors(koaCors: Koa.Middleware): <T extends new (...args: unknown[]) => object>(ctor: T) => void;
/**
 * Define Koa middleware that is applied in order to each endpoint in this class.
 */
export declare function KoaMiddleware(...koaMiddleware: Koa.Middleware[]): <T extends new (...args: unknown[]) => object>(ctor: T) => void;
/**
 * Define Koa middleware that is applied to all requests, including this class, other classes,
 *   or requests that do not end up in DBOS handlers at all.
 */
export declare function KoaGlobalMiddleware(...koaMiddleware: Koa.Middleware[]): <T extends new (...args: unknown[]) => object>(ctor: T) => void;
type SecurityScheme = Exclude<OpenApi3.SecuritySchemeObject, OpenApi3.OAuth2SecurityScheme>;
/**
 * Declare an OpenApi Security Scheme (https://spec.openapis.org/oas/v3.0.3#security-scheme-object
 * for the methods of a class. Note, this decorator is only used in OpenApi generation and does not
 * affect runtime behavior of the app.
 */
export declare function OpenApiSecurityScheme(securityScheme: SecurityScheme): <T extends new (...args: unknown[]) => object>(_ctor: T) => void;
export declare const RequestIDHeader = "X-Request-ID";
export declare function getOrGenerateRequestID(headers: IncomingHttpHeaders): string;
export declare function createHTTPSpan(request: HTTPRequest, httpTracer: W3CTraceContextPropagator): Span;
export declare function koaTracingMiddleware(ctx: Koa.Context, next: Koa.Next): Promise<void>;
export declare function expressTracingMiddleware(req: Request, res: Response, next: NextFunction): Promise<void>;
export {};
//# sourceMappingURL=middleware.d.ts.map