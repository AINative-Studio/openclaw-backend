"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.debugWorkflow = void 0;
const dbos_executor_1 = require("../dbos-executor");
const error_1 = require("../error");
const logs_1 = require("../telemetry/logs");
const runtime_1 = require("./runtime");
async function debugWorkflow(dbosConfig, runtimeConfig, workflowUUID, proxy) {
    dbosConfig = { ...dbosConfig, debugProxy: proxy, debugMode: true };
    const logger = new logs_1.GlobalLogger();
    try {
        const dbosExec = new dbos_executor_1.DBOSExecutor(dbosConfig);
        dbosExec.logger.debug(`Loading classes from entrypoints: ${JSON.stringify(runtimeConfig.entrypoints)}`);
        await runtime_1.DBOSRuntime.loadClasses(runtimeConfig.entrypoints);
        await dbosExec.init();
        // Invoke the workflow in debug mode.
        const handle = await dbosExec.executeWorkflowUUID(workflowUUID);
        await handle.getResult();
        // Destroy testing runtime.
        await dbosExec.destroy();
    }
    catch (e) {
        const errorLabel = `Debug mode error`;
        logger.error(`${errorLabel}: ${e.message}`);
        if (e instanceof AggregateError) {
            console.error(e.errors);
            for (const err of e.errors) {
                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
                if (err.code && err.code === "ECONNREFUSED") {
                    if (proxy !== undefined) {
                        console.error('\x1b[31m%s\x1b[0m', `Is DBOS time-travel debug proxy running at ${proxy} ?`);
                    }
                    else {
                        console.error('\x1b[31m%s\x1b[0m', `Is database running at ${dbosConfig.poolConfig.host} ?`);
                    }
                    break;
                }
            }
        }
        else if (e instanceof error_1.DBOSFailLoadOperationsError) {
            console.error('\x1b[31m%s\x1b[0m', "Did you compile this application? Hint: run `npm run build` and try again");
        }
        else if (e instanceof error_1.DBOSNotRegisteredError) {
            console.error('\x1b[31m%s\x1b[0m', "Did you modify this application? Hint: make sure the above function exists in your application, then run `npm run build` to re-compile and try again");
        }
        else if (e instanceof error_1.DBOSInitializationError) {
            console.error('\x1b[31m%s\x1b[0m', "Please check your configuration file and try again");
        }
        process.exit(1);
    }
    return;
}
exports.debugWorkflow = debugWorkflow;
//# sourceMappingURL=debug.js.map